### ä½¿ç”¨ Tree Sharking

#### è®¤è¯† Tree Sharking
Tree Sharking å¯ä»¥ç”¨æ¥å‰”é™¤ JavaScript ä¸­ç”¨ä¸ä¸Šçš„æ­»ä»£ç ã€‚å®ƒä¾èµ–é™æ€çš„ ES6 æ¨¡å—åŒ–è¯­æ³•ï¼Œä¾‹å¦‚é€šè¿‡ `import` å’Œ `export` å¯¼å…¥å¯¼å‡ºã€‚
Tree Sharking æœ€å…ˆåœ¨ Rollup ä¸­å‡ºç°ï¼ŒWebpack åœ¨ 2.0 ç‰ˆæœ¬ä¸­å°†å…¶å¼•å…¥ã€‚

ä¸ºäº†æ›´ç›´è§‚çš„ç†è§£å®ƒï¼Œæ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚å‡å¦‚æœ‰ä¸€ä¸ªæ–‡ä»¶ `util.js` é‡Œå­˜æ”¾äº†å¾ˆå¤šå·¥å…·å‡½æ•°å’Œå¸¸é‡ï¼Œåœ¨ `main.js` ä¸­ä¼šå¯¼å…¥å’Œä½¿ç”¨ `util.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

`util.js` æºç ï¼š
```js
export function funcA() {
}

export function funB() {
}
```

`main.js` æºç ï¼š
```js
import {funcA} from './util.js';
funcA();
```

Tree Sharking åçš„ `util.js`ï¼š
```js
export function funcA() {
}
```
ç”±äºåªç”¨åˆ°äº† `util.js` ä¸­çš„ `funcA`ï¼Œæ‰€ä»¥å‰©ä¸‹çš„éƒ½è¢« Tree Sharking å½“ä½œæ­»ä»£ç ç»™å‰”é™¤äº†ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯è¦è®© Tree Sharking æ­£å¸¸å·¥ä½œçš„å‰ææ˜¯äº¤ç»™ Webpack çš„ JavaScript ä»£ç å¿…é¡»æ˜¯é‡‡ç”¨ ES6 æ¨¡å—åŒ–è¯­æ³•çš„ï¼Œ
å› ä¸º ES6 æ¨¡å—åŒ–è¯­æ³•æ˜¯é™æ€çš„ï¼ˆå¯¼å…¥å¯¼å‡ºè¯­å¥ä¸­çš„è·¯å¾„å¿…é¡»æ˜¯é™æ€çš„å­—ç¬¦ä¸²ï¼Œè€Œä¸”ä¸èƒ½æ”¾å…¥å…¶å®ƒä»£ç å—ä¸­ï¼‰ï¼Œè¿™è®© Webpack å¯ä»¥ç®€å•çš„åˆ†æå‡ºå“ªäº› `export` çš„è¢« `import` è¿‡äº†ã€‚
å¦‚æœä½ é‡‡ç”¨ ES5 ä¸­çš„æ¨¡å—åŒ–ï¼Œä¾‹å¦‚ `module.export={...}`ã€`require(x+y)`ã€`if(x){require('./util')}`ï¼ŒWebpack æ— æ³•åˆ†æå‡ºå“ªäº›ä»£ç å¯ä»¥å‰”é™¤ã€‚
 
#### æ¥å…¥ Tree Sharking
ä¸Šé¢è®²äº† Tree Sharking æ˜¯åšä»€ä¹ˆçš„ï¼Œæ¥ä¸‹æ¥ä¸€æ­¥æ­¥æ•™ä½ å¦‚ä½•é…ç½® Webpack è®© Tree Sharking ç”Ÿæ•ˆã€‚

é¦–å…ˆï¼Œä¸ºäº†æŠŠé‡‡ç”¨ ES6 æ¨¡å—åŒ–çš„ä»£ç äº¤ç»™ Webpackï¼Œéœ€è¦é…ç½® Babel è®©å…¶ä¿ç•™ ES6 æ¨¡å—åŒ–è¯­å¥ï¼Œä¿®æ”¹ `.babelrc` æ–‡ä»¶ä¸ºå¦‚ä¸‹ï¼š
```json
{
  "presets": [
    [
      "env",
      {
        "modules": false
      }
    ]
  ]
}
```
å…¶ä¸­ `"modules": false` çš„å«ä¹‰æ˜¯å…³é—­ Babel çš„æ¨¡å—è½¬æ¢åŠŸèƒ½ï¼Œä¿ç•™åŸæœ¬çš„ ES6 æ¨¡å—åŒ–è¯­æ³•ã€‚

é…ç½®å¥½ Babel åï¼Œé‡æ–°è¿è¡Œ Webpackï¼Œåœ¨å¯åŠ¨ Webpack æ—¶å¸¦ä¸Š `--display-used-exports` å‚æ•°ï¼Œè¿™æ—¶ä½ ä¼šå‘ç°åœ¨æ§åˆ¶å°ä¸­è¾“å‡ºäº†å¦‚ä¸‹çš„æ—¥å¿—ï¼š
```
> webpack --display-used-exports
bundle.js  3.5 kB       0  [emitted]  main
   [0] ./main.js 41 bytes {0} [built]
   [1] ./util.js 511 bytes {0} [built]
       [only some exports used: funcA]
```
å…¶ä¸­ `[only some exports used: funcA]` æç¤ºäº† `util.js` åªå¯¼å‡ºäº†ç”¨åˆ°çš„ `funcA`ï¼Œè¯´æ˜ Webpack ç¡®å®æ­£ç¡®çš„åˆ†æå‡ºäº†å¦‚ä½•å‰”é™¤æ­»ä»£ç ã€‚

ä½†å½“ä½ æ‰“å¼€ Webpack è¾“å‡ºçš„ `bundle.js` æ–‡ä»¶çœ‹ä¸‹æ—¶ï¼Œä½ ä¼šå‘ç°ç”¨ä¸ä¸Šçš„ä»£ç è¿˜åœ¨é‡Œé¢ï¼Œå¦‚ä¸‹ï¼š
```js
/* harmony export (immutable) */
__webpack_exports__["a"] = funcA;

/* unused harmony export funB */

function funcA() {
  console.log('funcA');
}

function funB() {
  console.log('funcB');
}
```
Webpack åªæ˜¯æŒ‡å‡ºäº†å“ªäº›å‡½æ•°ç”¨ä¸Šäº†å“ªäº›æ²¡ç”¨ä¸Šï¼Œè¦å‰”é™¤ç”¨ä¸ä¸Šçš„ä»£ç è¿˜å¾—ç»è¿‡ UglifyJS å»å¤„ç†ä¸€éã€‚
è¦æ¥å…¥ UglifyJS ä¹Ÿå¾ˆç®€å•ï¼Œå³å¯ä»¥é€šè¿‡[4-8å‹ç¼©ä»£ç ](4-8å‹ç¼©ä»£ç .md)ä¸­ä»‹ç»çš„åŠ å…¥ UglifyJSPlugin å»å®ç°ï¼Œ
ä¹Ÿå¯ä»¥ç®€å•çš„é€šè¿‡åœ¨å¯åŠ¨ Webpack æ—¶å¸¦ä¸Š `--optimize-minimize` å‚æ•°ï¼Œä¸ºäº†å¿«é€ŸéªŒè¯ Tree Sharking æˆ‘ä»¬é‡‡ç”¨è¾ƒç®€å•çš„åè€…æ¥å®éªŒä¸‹ã€‚

é€šè¿‡ `webpack --display-used-exports --optimize-minimize` é‡å¯ Webpack åï¼Œæ‰“å¼€æ–°è¾“å‡ºçš„ `bundle.js`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```js
function r() {
  console.log("funcA")
}

t.a = r
```
å¯ä»¥çœ‹å‡º Tree Sharking ç¡®å®åšåˆ°äº†ï¼Œç”¨ä¸ä¸Šçš„ä»£ç éƒ½è¢«å‰”é™¤äº†ã€‚


å½“ä½ çš„é¡¹ç›®ä½¿ç”¨äº†å¤§é‡ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œä½ ä¼šå‘ç° Tree Sharking ä¼¼ä¹ä¸ç”Ÿæ•ˆäº†ï¼ŒåŸå› æ˜¯å¤§éƒ¨åˆ† Npm ğŸ€„ï¸ä¸­çš„ä»£ç éƒ½æ˜¯é‡‡ç”¨çš„ CommonJS è¯­æ³•ï¼Œ
è¿™å¯¼è‡´ Tree Sharking æ— æ³•ç”Ÿæ•ˆã€‚
ä½†å¹¸è¿çš„æ—¶æœ‰äº›åº“è€ƒè™‘åˆ°äº†è¿™ç‚¹ï¼Œè¿™äº›åº“åœ¨å‘å¸ƒåˆ° Npm ä¸Šæ—¶ä¼šåŒæ—¶æä¾›ä¸¤ä»½ä»£ç ï¼Œä¸€ä»½é‡‡ç”¨ CommonJS æ¨¡å—åŒ–è¯­æ³•ï¼Œä¸€ä»½é‡‡ç”¨ ES6 æ¨¡å—åŒ–è¯­æ³•ã€‚
å¹¶ä¸”åœ¨ `package.json` æ–‡ä»¶ä¸­åˆ†åˆ«æŒ‡å‡ºè¿™ä¸¤ä»½ä»£ç çš„å…¥å£ã€‚

ä»¥ `redux` åº“ä¸ºä¾‹ï¼Œå…¶å‘å¸ƒåˆ° Npm ä¸Šçš„ç›®å½•ç»“æ„ä¸ºï¼š
```
node_modules/redux
|-- es
|   |-- index.js # é‡‡ç”¨ ES6 æ¨¡å—åŒ–è¯­æ³•
|-- lib
|   |-- index.js # é‡‡ç”¨ ES5 æ¨¡å—åŒ–è¯­æ³•
|-- package.json
```
`package.json` æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªå­—æ®µï¼š
```json
{
  "main": "lib/index.js", // æŒ‡æ˜é‡‡ç”¨ CommonJS æ¨¡å—åŒ–çš„ä»£ç å…¥å£
  "jsnext:main": "es/index.js" // æŒ‡æ˜é‡‡ç”¨ ES6 æ¨¡å—åŒ–çš„ä»£ç å…¥å£
}
```
åœ¨[2-4Resolve mainFields](../2é…ç½®/2-4Resolve.md#mainFields) ä¸­æ›¾ä»‹ç»è¿‡ `mainFields` ç”¨äºé…ç½®é‡‡ç”¨å“ªä¸ªå­—æ®µä½œä¸ºæ¨¡å—çš„å…¥å£æè¿°ã€‚
ä¸ºäº†è®© Tree Sharking å¯¹ `redux` ç”Ÿæ•ˆï¼Œéœ€è¦é…ç½® Webpack çš„æ–‡ä»¶å¯»æ‰¾è§„åˆ™ä¸ºå¦‚ä¸‹ï¼š
```js
module.exports = {
  resolve: {
    // é’ˆå¯¹ Npm ä¸­çš„ç¬¬ä¸‰æ–¹æ¨¡å—ä¼˜å…ˆé‡‡ç”¨ jsnext:main ä¸­æŒ‡å‘çš„ ES6 æ¨¡å—åŒ–è¯­æ³•çš„æ–‡ä»¶
    mainFields: ['jsnext:main', 'browser', 'main']
  },
};
```
ä»¥ä¸Šé…ç½®çš„å«ä¹‰æ˜¯ä¼˜å…ˆä½¿ç”¨ `jsnext:main` ä½œä¸ºå…¥å£ï¼Œå¦‚æœä¸å­˜åœ¨ `jsnext:main` å°±é‡‡ç”¨ `browser` æˆ–è€… `main` ä½œä¸ºå…¥å£ã€‚
è™½ç„¶å¹¶ä¸æ˜¯æ¯ä¸ª Npm ä¸­çš„ç¬¬ä¸‰æ–¹æ¨¡å—éƒ½ä¼šæä¾› ES6 æ¨¡å—åŒ–è¯­æ³•çš„ä»£ç ï¼Œä½†å¯¹äºæä¾›äº†çš„ä¸èƒ½æ”¾è¿‡ï¼Œèƒ½ä¼˜åŒ–å°±ä¼˜åŒ–ã€‚

ç›®å‰è¶Šæ¥è¶Šå¤šçš„ Npm ä¸­çš„ç¬¬ä¸‰æ–¹æ¨¡å—è€ƒè™‘åˆ°äº† Tree Sharkingï¼Œå¹¶å¯¹å…¶æä¾›äº†æ”¯æŒã€‚
é‡‡ç”¨ `jsnext:main` ä½œä¸º ES6 æ¨¡å—åŒ–ä»£ç çš„å…¥å£æ˜¯ç¤¾åŒºçš„ä¸€ä¸ªçº¦å®šï¼Œå‡å¦‚å°†æ¥ä½ è¦å‘å¸ƒä¸€ä¸ªåº“åˆ° Npm æ—¶ï¼Œå¸Œæœ›ä½ èƒ½æ”¯æŒ Tree Sharkingï¼Œ
ä»¥è®© Tree Sharking å‘æŒ¥æ›´å¤§çš„ä¼˜åŒ–æ•ˆæœï¼Œè®©æ›´å¤šçš„äººä¸ºæ­¤å—ç›Šã€‚

> æœ¬å®ä¾‹[æä¾›é¡¹ç›®å®Œæ•´ä»£ç ](http://webpack.wuhaolin.cn/4-10ä½¿ç”¨TreeSharking.zip)

